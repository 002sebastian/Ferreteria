-- Crear base de datos y usarla
CREATE DATABASE IF NOT EXISTS ferreteria_db;
USE ferreteria_db;

-- Tablas auxiliares / cat√°logos
CREATE TABLE IF NOT EXISTS forma_pago (
    id_forma_pago INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(30) NOT NULL UNIQUE,
    descripcion VARCHAR(100)
);

CREATE TABLE IF NOT EXISTS direccion (
    id_direccion INT AUTO_INCREMENT PRIMARY KEY,
    calle VARCHAR(120),
    numero VARCHAR(20),
    localidad VARCHAR(100),
    barrio VARCHAR(100),
    ciudad VARCHAR(100),
    departamento VARCHAR(100),
    pais VARCHAR(100) DEFAULT 'Colombia',
    referencia TEXT
);

-- Entidades principales
CREATE TABLE IF NOT EXISTS ferreteria (
    id_ferreteria INT AUTO_INCREMENT PRIMARY KEY,
    nit VARCHAR(50) NOT NULL UNIQUE,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    telefono VARCHAR(50),
    email VARCHAR(100),
    estado ENUM('ACTIVO','INACTIVO') DEFAULT 'ACTIVO',
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_ferreteria_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE TABLE IF NOT EXISTS empleado (
    id_empleado INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    nombre VARCHAR(80) NOT NULL,
    apellido VARCHAR(80) NOT NULL,
    cargo VARCHAR(80),
    fecha_contratacion DATE,
    id_direccion INT,
    email VARCHAR(100),
    telefono VARCHAR(50),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_empleado_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_empleado_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX (id_ferreteria)
);

CREATE TABLE IF NOT EXISTS cliente (
    id_cliente INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    rut VARCHAR(50) NOT NULL,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    email VARCHAR(100),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_cliente_rut UNIQUE (id_ferreteria, rut),
    CONSTRAINT fk_cliente_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_cliente_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX (id_ferreteria)
);

CREATE TABLE IF NOT EXISTS cliente_telefono (
    id_telefono INT AUTO_INCREMENT PRIMARY KEY,
    id_cliente INT NOT NULL,
    telefono VARCHAR(50) NOT NULL,
    CONSTRAINT fk_cliente_tel_cliente FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente)
        ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX (id_cliente)
);

CREATE TABLE IF NOT EXISTS proveedor (
    id_proveedor INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    rut VARCHAR(50) NOT NULL,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    telefono VARCHAR(50),
    pagina_web VARCHAR(200),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_proveedor_rut UNIQUE (id_ferreteria, rut),
    CONSTRAINT fk_proveedor_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_proveedor_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX (id_ferreteria)
);

CREATE TABLE IF NOT EXISTS calificacion_proveedor (
    id_calificacion INT AUTO_INCREMENT PRIMARY KEY,
    id_proveedor INT NOT NULL,
    id_empleado INT,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    puntualidad TINYINT UNSIGNED NOT NULL,
    calidad TINYINT UNSIGNED NOT NULL,
    cumplimiento TINYINT UNSIGNED NOT NULL,
    comentarios TEXT,
    CONSTRAINT fk_calif_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_calif_empleado FOREIGN KEY (id_empleado) REFERENCES empleado(id_empleado)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX (id_proveedor, fecha)
);

CREATE TABLE IF NOT EXISTS categoria_producto (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    iva DECIMAL(5,2) NOT NULL DEFAULT 0.00
);

CREATE TABLE IF NOT EXISTS producto (
    id_producto INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_proveedor INT,
    id_categoria INT NOT NULL,
    codigo VARCHAR(50) NULL,
    nombre VARCHAR(200) NOT NULL,
    presentacion VARCHAR(100),
    precio_compra DECIMAL(12,2) DEFAULT 0.00,
    precio_venta DECIMAL(12,2) DEFAULT 0.00,
    descuento DECIMAL(7,2) DEFAULT 0.00,
    stock_minimo INT DEFAULT 0,
    stock_actual INT DEFAULT 0,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_prod_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_prod_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_prod_categoria FOREIGN KEY (id_categoria) REFERENCES categoria_producto(id_categoria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    UNIQUE KEY uq_producto_codigo (id_ferreteria, codigo),
    INDEX (id_proveedor),
    INDEX (id_categoria),
    INDEX (stock_actual)
);

CREATE TABLE IF NOT EXISTS pedido (
    id_pedido INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_proveedor INT NOT NULL,
    fecha_pedido DATETIME DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('PENDIENTE','RECIBIDO','PARCIAL','CANCELADO') DEFAULT 'PENDIENTE',
    fecha_entrega_estimada DATE,
    comentarios TEXT,
    CONSTRAINT fk_pedido_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_pedido_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (id_proveedor, estado, fecha_pedido)
);

CREATE TABLE IF NOT EXISTS detalle_pedido (
    id_detalle_pedido INT AUTO_INCREMENT PRIMARY KEY,
    id_pedido INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad INT NOT NULL,
    precio_compra DECIMAL(12,2) NOT NULL,
    subtotal DECIMAL(14,2) AS (cantidad * precio_compra) STORED,
    CONSTRAINT fk_detpedido_pedido FOREIGN KEY (id_pedido) REFERENCES pedido(id_pedido)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detpedido_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (id_pedido),
    INDEX (id_producto)
);

CREATE TABLE IF NOT EXISTS recepcion (
    id_recepcion INT AUTO_INCREMENT PRIMARY KEY,
    id_pedido INT NOT NULL,
    fecha_recepcion DATETIME DEFAULT CURRENT_TIMESTAMP,
    id_empleado INT,
    observaciones TEXT,
    CONSTRAINT fk_recepcion_pedido FOREIGN KEY (id_pedido) REFERENCES pedido(id_pedido)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_recepcion_empleado FOREIGN KEY (id_empleado) REFERENCES empleado(id_empleado)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX (id_pedido, fecha_recepcion)
);

CREATE TABLE IF NOT EXISTS detalle_recepcion (
    id_detalle_recepcion INT AUTO_INCREMENT PRIMARY KEY,
    id_recepcion INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad_recibida INT NOT NULL,
    precio_compra DECIMAL(12,2),
    CONSTRAINT fk_detrec_recepcion FOREIGN KEY (id_recepcion) REFERENCES recepcion(id_recepcion)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detrec_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (id_recepcion),
    INDEX (id_producto)
);

CREATE TABLE IF NOT EXISTS movimiento_inventario (
    id_movimiento INT AUTO_INCREMENT PRIMARY KEY,
    id_producto INT NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    tipo_movimiento ENUM('ENTRADA','SALIDA','AJUSTE') NOT NULL,
    cantidad INT NOT NULL,
    referencia_tabla VARCHAR(50),
    referencia_id INT,
    descripcion TEXT,
    CONSTRAINT fk_movinv_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX (id_producto, fecha)
);

CREATE TABLE IF NOT EXISTS factura_venta (
    id_factura INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_cliente INT NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    descuento_global DECIMAL(12,2) DEFAULT 0.00,
    subtotal DECIMAL(14,2) DEFAULT 0.00,
    iva_total DECIMAL(14,2) DEFAULT 0.00,
    monto_final DECIMAL(14,2) DEFAULT 0.00,
    num_items INT DEFAULT 0,
    estado ENUM('PAGADA','PENDIENTE','ANULADA') DEFAULT 'PENDIENTE',
    CONSTRAINT fk_factura_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_factura_cliente FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (fecha),
    INDEX (id_cliente)
);

CREATE TABLE IF NOT EXISTS detalle_factura (
    id_detalle INT AUTO_INCREMENT PRIMARY KEY,
    id_factura INT NOT NULL,
    id_producto INT NOT NULL,
    precio_venta_momento DECIMAL(12,2) NOT NULL,
    cantidad INT NOT NULL,
    subtotal DECIMAL(14,2) AS (precio_venta_momento * cantidad) STORED,
    iva_aplicado DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    CONSTRAINT fk_detfac_factura FOREIGN KEY (id_factura) REFERENCES factura_venta(id_factura)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detfac_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (id_factura),
    INDEX (id_producto)
);

CREATE TABLE IF NOT EXISTS factura_pago (
    id_factura_pago INT AUTO_INCREMENT PRIMARY KEY,
    id_factura INT NOT NULL,
    id_forma_pago INT NOT NULL,
    monto DECIMAL(14,2) NOT NULL,
    referencia VARCHAR(200),
    fecha_pago DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_facturapago_factura FOREIGN KEY (id_factura) REFERENCES factura_venta(id_factura)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_facturapago_formapago FOREIGN KEY (id_forma_pago) REFERENCES forma_pago(id_forma_pago)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX (id_factura),
    INDEX (id_forma_pago)
);

-- FIN DEL SCRIPT DDL
