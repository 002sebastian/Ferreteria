_____________________________________________________________

CREATE DATABASE ferreteria_db;

____________________________________________________________

-- ======================================================
-- TABLAS CATALOGO / AUXILIARES (sin datos)
-- ======================================================
CREATE TABLE forma_pago (
    id_forma_pago INT AUTO_INCREMENT PRIMARY KEY,
    codigo VARCHAR(30) NOT NULL UNIQUE,
    descripcion VARCHAR(100)
);

CREATE TABLE direccion (
    id_direccion INT AUTO_INCREMENT PRIMARY KEY,
    calle VARCHAR(120),
    numero VARCHAR(20),
    localidad VARCHAR(100),
    barrio VARCHAR(100),
    ciudad VARCHAR(100),
    departamento VARCHAR(100),
    pais VARCHAR(100) DEFAULT 'Colombia',
    referencia TEXT
);

-- ======================================================
-- ENTIDADES PRINCIPALES
-- ======================================================
CREATE TABLE ferreteria (
    id_ferreteria INT AUTO_INCREMENT PRIMARY KEY,
    nit VARCHAR(50) NOT NULL UNIQUE,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    telefono VARCHAR(50),
    email VARCHAR(100),
    estado ENUM('ACTIVO','INACTIVO') DEFAULT 'ACTIVO',
    fecha_registro DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_ferreteria_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE
);

CREATE TABLE empleado (
    id_empleado INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    nombre VARCHAR(80) NOT NULL,
    apellido VARCHAR(80) NOT NULL,
    cargo VARCHAR(80),
    fecha_contratacion DATE,
    id_direccion INT,
    email VARCHAR(100),
    telefono VARCHAR(50),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_empleado_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_empleado_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_empleado_ferreteria (id_ferreteria)
);

CREATE TABLE cliente (
    id_cliente INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    rut VARCHAR(50) NOT NULL,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    email VARCHAR(100),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_cliente_rut UNIQUE (id_ferreteria, rut),
    CONSTRAINT fk_cliente_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_cliente_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_cliente_ferreteria (id_ferreteria)
);

CREATE TABLE cliente_telefono (
    id_telefono INT AUTO_INCREMENT PRIMARY KEY,
    id_cliente INT NOT NULL,
    telefono VARCHAR(50) NOT NULL,
    CONSTRAINT fk_cliente_tel_cliente FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente)
        ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_cliente_telefono (id_cliente)
);

CREATE TABLE proveedor (
    id_proveedor INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    rut VARCHAR(50) NOT NULL,
    nombre VARCHAR(150) NOT NULL,
    id_direccion INT,
    telefono VARCHAR(50),
    pagina_web VARCHAR(200),
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT uq_proveedor_rut UNIQUE (id_ferreteria, rut),
    CONSTRAINT fk_proveedor_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_proveedor_direccion FOREIGN KEY (id_direccion) REFERENCES direccion(id_direccion)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_proveedor_ferreteria (id_ferreteria)
);

CREATE TABLE calificacion_proveedor (
    id_calificacion INT AUTO_INCREMENT PRIMARY KEY,
    id_proveedor INT NOT NULL,
    id_empleado INT,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    puntualidad TINYINT UNSIGNED NOT NULL,
    calidad TINYINT UNSIGNED NOT NULL,
    cumplimiento TINYINT UNSIGNED NOT NULL,
    comentarios TEXT,
    CONSTRAINT fk_calif_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_calif_empleado FOREIGN KEY (id_empleado) REFERENCES empleado(id_empleado)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_calif_proveedor_fecha (id_proveedor, fecha)
);

CREATE TABLE categoria_producto (
    id_categoria INT AUTO_INCREMENT PRIMARY KEY,
    nombre VARCHAR(100) NOT NULL,
    descripcion TEXT,
    iva DECIMAL(5,2) NOT NULL DEFAULT 0.00
);

CREATE TABLE producto (
    id_producto INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_proveedor INT,
    id_categoria INT NOT NULL,
    codigo VARCHAR(50) NULL,
    nombre VARCHAR(200) NOT NULL,
    presentacion VARCHAR(100),
    precio_compra DECIMAL(12,2) DEFAULT 0.00,
    precio_venta DECIMAL(12,2) DEFAULT 0.00,
    descuento DECIMAL(7,2) DEFAULT 0.00,
    stock_minimo INT DEFAULT 0,
    stock_actual INT DEFAULT 0,
    fecha_creacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_prod_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_prod_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE SET NULL ON UPDATE CASCADE,
    CONSTRAINT fk_prod_categoria FOREIGN KEY (id_categoria) REFERENCES categoria_producto(id_categoria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    UNIQUE KEY uq_producto_codigo (id_ferreteria, codigo),
    INDEX idx_producto_proveedor (id_proveedor),
    INDEX idx_producto_categoria (id_categoria),
    INDEX idx_producto_stock (stock_actual)
);

CREATE TABLE pedido (
    id_pedido INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_proveedor INT NOT NULL,
    fecha_pedido DATETIME DEFAULT CURRENT_TIMESTAMP,
    estado ENUM('PENDIENTE','RECIBIDO','PARCIAL','CANCELADO') DEFAULT 'PENDIENTE',
    fecha_entrega_estimada DATE,
    comentarios TEXT,
    CONSTRAINT fk_pedido_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_pedido_proveedor FOREIGN KEY (id_proveedor) REFERENCES proveedor(id_proveedor)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_pedido_proveedor_estado_fecha (id_proveedor, estado, fecha_pedido)
);

CREATE TABLE detalle_pedido (
    id_detalle_pedido INT AUTO_INCREMENT PRIMARY KEY,
    id_pedido INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad INT NOT NULL,
    precio_compra DECIMAL(12,2) NOT NULL,
    subtotal DECIMAL(14,2) AS (cantidad * precio_compra) STORED,
    CONSTRAINT fk_detpedido_pedido FOREIGN KEY (id_pedido) REFERENCES pedido(id_pedido)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detpedido_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_detpedido_pedido (id_pedido),
    INDEX idx_detpedido_producto (id_producto)
);

CREATE TABLE recepcion (
    id_recepcion INT AUTO_INCREMENT PRIMARY KEY,
    id_pedido INT NOT NULL,
    fecha_recepcion DATETIME DEFAULT CURRENT_TIMESTAMP,
    id_empleado INT,
    observaciones TEXT,
    CONSTRAINT fk_recepcion_pedido FOREIGN KEY (id_pedido) REFERENCES pedido(id_pedido)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_recepcion_empleado FOREIGN KEY (id_empleado) REFERENCES empleado(id_empleado)
        ON DELETE SET NULL ON UPDATE CASCADE,
    INDEX idx_recepcion_pedido_fecha (id_pedido, fecha_recepcion)
);

CREATE TABLE detalle_recepcion (
    id_detalle_recepcion INT AUTO_INCREMENT PRIMARY KEY,
    id_recepcion INT NOT NULL,
    id_producto INT NOT NULL,
    cantidad_recibida INT NOT NULL,
    precio_compra DECIMAL(12,2),
    CONSTRAINT fk_detrec_recepcion FOREIGN KEY (id_recepcion) REFERENCES recepcion(id_recepcion)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detrec_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_detrec_recepcion (id_recepcion),
    INDEX idx_detrec_producto (id_producto)
);

CREATE TABLE movimiento_inventario (
    id_movimiento INT AUTO_INCREMENT PRIMARY KEY,
    id_producto INT NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    tipo_movimiento ENUM('ENTRADA','SALIDA','AJUSTE') NOT NULL,
    cantidad INT NOT NULL,
    referencia_tabla VARCHAR(50),
    referencia_id INT,
    descripcion TEXT,
    CONSTRAINT fk_movinv_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE CASCADE ON UPDATE CASCADE,
    INDEX idx_movinv_producto_fecha (id_producto, fecha)
);

CREATE TABLE factura_venta (
    id_factura INT AUTO_INCREMENT PRIMARY KEY,
    id_ferreteria INT NOT NULL,
    id_cliente INT NOT NULL,
    fecha DATETIME DEFAULT CURRENT_TIMESTAMP,
    descuento_global DECIMAL(12,2) DEFAULT 0.00,
    subtotal DECIMAL(14,2) DEFAULT 0.00,
    iva_total DECIMAL(14,2) DEFAULT 0.00,
    monto_final DECIMAL(14,2) DEFAULT 0.00,
    num_items INT DEFAULT 0,
    estado ENUM('PAGADA','PENDIENTE','ANULADA') DEFAULT 'PENDIENTE',
    CONSTRAINT fk_factura_ferreteria FOREIGN KEY (id_ferreteria) REFERENCES ferreteria(id_ferreteria)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    CONSTRAINT fk_factura_cliente FOREIGN KEY (id_cliente) REFERENCES cliente(id_cliente)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_factura_fecha (fecha),
    INDEX idx_factura_cliente (id_cliente)
);

CREATE TABLE detalle_factura (
    id_detalle INT AUTO_INCREMENT PRIMARY KEY,
    id_factura INT NOT NULL,
    id_producto INT NOT NULL,
    precio_venta_momento DECIMAL(12,2) NOT NULL,
    cantidad INT NOT NULL,
    subtotal DECIMAL(14,2) AS (precio_venta_momento * cantidad) STORED,
    iva_aplicado DECIMAL(12,2) NOT NULL DEFAULT 0.00,
    CONSTRAINT fk_detfac_factura FOREIGN KEY (id_factura) REFERENCES factura_venta(id_factura)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_detfac_producto FOREIGN KEY (id_producto) REFERENCES producto(id_producto)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_detfac_factura (id_factura),
    INDEX idx_detfac_producto (id_producto)
);

CREATE TABLE factura_pago (
    id_factura_pago INT AUTO_INCREMENT PRIMARY KEY,
    id_factura INT NOT NULL,
    id_forma_pago INT NOT NULL,
    monto DECIMAL(14,2) NOT NULL,
    referencia VARCHAR(200),
    fecha_pago DATETIME DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_facturapago_factura FOREIGN KEY (id_factura) REFERENCES factura_venta(id_factura)
        ON DELETE CASCADE ON UPDATE CASCADE,
    CONSTRAINT fk_facturapago_formapago FOREIGN KEY (id_forma_pago) REFERENCES forma_pago(id_forma_pago)
        ON DELETE RESTRICT ON UPDATE CASCADE,
    INDEX idx_facturapago_factura (id_factura),
    INDEX idx_facturapago_formapago (id_forma_pago)
);

-- ======================================================
-- PROCEDIMIENTOS / FUNCIONES AUXILIARES (sin datos)
-- ======================================================
DELIMITER $$
CREATE PROCEDURE sp_recalc_totales_factura (IN p_id_factura INT)
BEGIN
    DECLARE v_subtotal DECIMAL(14,2) DEFAULT 0.00;
    DECLARE v_iva DECIMAL(14,2) DEFAULT 0.00;
    DECLARE v_num_items INT DEFAULT 0;
    SELECT COALESCE(SUM(subtotal),0), COALESCE(SUM(iva_aplicado),0), COALESCE(SUM(cantidad),0)
    INTO v_subtotal, v_iva, v_num_items
    FROM detalle_factura
    WHERE id_factura = p_id_factura;

    UPDATE factura_venta
    SET subtotal = v_subtotal,
        iva_total = v_iva,
        num_items = v_num_items,
        monto_final = (v_subtotal - COALESCE(descuento_global,0) + v_iva)
    WHERE id_factura = p_id_factura;
END$$
DELIMITER ;

-- ======================================================
-- TRIGGERS: control de stock y recálculo totales factura
-- ======================================================

DELIMITER $$
CREATE TRIGGER trg_detalle_factura_before_insert
BEFORE INSERT ON detalle_factura
FOR EACH ROW
BEGIN
    DECLARE v_stock INT;
    SELECT stock_actual INTO v_stock FROM producto WHERE id_producto = NEW.id_producto FOR UPDATE;
    IF v_stock IS NULL THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Producto no existe.';
    END IF;
    IF v_stock < NEW.cantidad THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Stock insuficiente para el producto.';
    END IF;
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_detalle_factura_after_insert
AFTER INSERT ON detalle_factura
FOR EACH ROW
BEGIN
    UPDATE producto
    SET stock_actual = stock_actual - NEW.cantidad
    WHERE id_producto = NEW.id_producto;

    INSERT INTO movimiento_inventario (id_producto, tipo_movimiento, cantidad, referencia_tabla, referencia_id, descripcion)
    VALUES (NEW.id_producto, 'SALIDA', NEW.cantidad, 'factura', NEW.id_factura, CONCAT('Venta - detalle_factura id: ', NEW.id_detalle));

    CALL sp_recalc_totales_factura(NEW.id_factura);
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_detalle_factura_after_update
AFTER UPDATE ON detalle_factura
FOR EACH ROW
BEGIN
    DECLARE v_diff INT;
    SET v_diff = NEW.cantidad - OLD.cantidad;
    IF v_diff <> 0 THEN
        IF v_diff > 0 THEN
            DECLARE v_stock INT;
            SELECT stock_actual INTO v_stock FROM producto WHERE id_producto = NEW.id_producto FOR UPDATE;
            IF v_stock < v_diff THEN
                SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Stock insuficiente para actualizar cantidad en detalle_factura.';
            END IF;
        END IF;

        UPDATE producto
        SET stock_actual = stock_actual - v_diff
        WHERE id_producto = NEW.id_producto;

        INSERT INTO movimiento_inventario (id_producto, tipo_movimiento, cantidad, referencia_tabla, referencia_id, descripcion)
        VALUES (NEW.id_producto, 'AJUSTE', v_diff, 'detalle_factura_update', NEW.id_detalle, CONCAT('Ajuste por actualización de detalle_factura. Old qty=', OLD.cantidad, ', New qty=', NEW.cantidad));
    END IF;

    CALL sp_recalc_totales_factura(NEW.id_factura);
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_detalle_factura_after_delete
AFTER DELETE ON detalle_factura
FOR EACH ROW
BEGIN
    UPDATE producto
    SET stock_actual = stock_actual + OLD.cantidad
    WHERE id_producto = OLD.id_producto;

    INSERT INTO movimiento_inventario (id_producto, tipo_movimiento, cantidad, referencia_tabla, referencia_id, descripcion)
    VALUES (OLD.id_producto, 'ENTRADA', OLD.cantidad, 'detalle_factura_delete', OLD.id_detalle, CONCAT('Devolución/Anulación - detalle_factura id:', OLD.id_detalle));

    CALL sp_recalc_totales_factura(OLD.id_factura);
END$$
DELIMITER ;

DELIMITER $$
CREATE TRIGGER trg_detalle_recepcion_after_insert
AFTER INSERT ON detalle_recepcion
FOR EACH ROW
BEGIN
    UPDATE producto
    SET stock_actual = stock_actual + NEW.cantidad_recibida
    WHERE id_producto = NEW.id_producto;

    INSERT INTO movimiento_inventario (id_producto, tipo_movimiento, cantidad, referencia_tabla, referencia_id, descripcion)
    VALUES (NEW.id_producto, 'ENTRADA', NEW.cantidad_recibida, 'recepcion', NEW.id_recepcion, CONCAT('Recepción - detalle_recepcion id: ', NEW.id_detalle_recepcion));
END$$
DELIMITER ;

-- ======================================================
-- FIN DEL SCRIPT DDL
-- ======================================================
